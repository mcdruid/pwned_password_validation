<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
const HIBP_API_URL = 'https://haveibeenpwned.com/api/v2/pwnedpassword/';

/**
 * Check a password with an API call to haveibeenpwned.
 *
 * @todo: Wrap the check in some cacheing to avoid repeated API calls.
 * @todo: Check for 429 responses (rate limit has been exceeded).
 *
 * @param string $password
 *   The plain text password.
 *
 * @return boolean
 *   Whether the password was found in the Pwned Passwords repository.
 */
function pwned_password_validation_check_password($password) {
  $hash = hash('sha1', $password);
  $result = Drupal::httpClient()->get(HIBP_API_URL . $hash, ['http_errors' => FALSE]);
  return ($result->getStatusCode() == 200);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function pwned_password_validation_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['#validate'][] = 'pwned_password_validation_user_login_form_validate';
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function pwned_password_validation_form_user_register_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Only add password validation if a password is going to be provided at registration.
  $account = \Drupal::currentUser();
  $config = \Drupal::config('user.settings');
  if ($account->isAnonymous() and !$config->get('verify_mail')) {
    $form['#validate'][] = 'pwned_password_validation_user_register_form_validate';
  }
}

/**
 * @param $form
 * @param FormStateInterface $form_state
 */
function pwned_password_validation_user_login_form_validate($form, FormStateInterface $form_state) {
  if (isset($form_state->getUserInput()['pass'])) {
    if (pwned_password_validation_check_password($form_state->getUserInput()['pass'])) {

      // At validation, the user is not yet authenticated so we can't provide an edit link.
      drupal_set_message(t('The password you are using on this site has ' .
        'previously appeared in a data breach of another site. ' .
        '<strong>This is not related to a security incident on this site</strong>, ' .
        'however the fact that it has previously appeared elsewhere puts your ' .
        'account at risk. You should consider changing your password on this site ' .
        'as well as on any other site you may have used it.'
      ), 'warning');
    }
  }
}

/**
 * @param $form
 * @param FormStateInterface $form_state
 */
function pwned_password_validation_user_register_form_validate($form, FormStateInterface $form_state) {
  if (isset($form_state->getUserInput()['pass'])) {
    if (is_array($passwords = $form_state->getUserInput()['pass'])) {
      if (count(($password = array_unique($passwords))) > 1) {
        // Passwords didn't match.
        return;
      }
      else {
        $pass = array_pop($password);
      }
    }
    if (pwned_password_validation_check_password($pass)) {

      // At validation, the user is not yet authenticated so we can't provide an edit link.
      drupal_set_message(t('The password you are using on this site has ' .
          'previously appeared in a data breach of another site. ' .
          '<strong>This is not related to a security incident on this site</strong>, ' .
          'however the fact that it has previously appeared elsewhere puts your ' .
          'account at risk. You should consider changing your password on this site ' .
          'as well as on any other site you may have used it.'
      ), 'warning');
    }
  }
}